<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Heart to Heart | ISA Chulalongkorn</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Lato:wght@300;400&family=Pinyon+Script&display=swap');

    :root{
      --gold:#c5a059;
      --deep-green:#1a2a1d;
      --cream:#f8f5f0;
      --blush:#e8d5d1;
      --ink: rgba(26,42,29,0.86);
    }

    /* Keep body hidden overflow (background cinematic),
       BUT make the app scrollable (fix: only 4 tiles visible). */
    html, body{
      width:100%; height:100%;
      margin:0; padding:0;
      background: var(--cream);
      overflow:hidden;
      -webkit-text-size-adjust:100%;
      touch-action:manipulation;
    }

    body{
      min-height:100svh;
      background-color:var(--cream);
      color:var(--deep-green);
      font-family:'Lato', sans-serif;
      display:flex;
      justify-content:center;
      align-items:center;
      transition: background-color 1.05s ease;
      position:relative;
    }

    /* App becomes scroll container */
    #app-container{
      height: 100svh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      text-align:center;
      width:100%;
      max-width:1200px;
      padding:20px 20px 40px;
      z-index:10;
      box-sizing:border-box;
      position:relative;
    }

    /* =========================
       SECRET GARDEN BACKGROUND
       ========================= */
    .garden-bg{
      position:fixed; inset:0;
      z-index:0;
      pointer-events:none;
      overflow:hidden;
      background:
        radial-gradient(900px 700px at 20% 20%, rgba(197,160,89,0.14), transparent 60%),
        radial-gradient(800px 650px at 80% 30%, rgba(232,213,209,0.14), transparent 55%),
        radial-gradient(900px 700px at 40% 90%, rgba(26,42,29,0.12), transparent 55%),
        linear-gradient(120deg, rgba(248,245,240,1), rgba(248,245,240,1));
    }
    .garden-bg::before{
      content:"";
      position:absolute; inset:-35%;
      background:
        radial-gradient(circle at 22% 28%, rgba(255,255,255,0.60), transparent 58%),
        radial-gradient(circle at 78% 44%, rgba(255,255,255,0.38), transparent 62%),
        radial-gradient(circle at 52% 74%, rgba(255,255,255,0.26), transparent 68%),
        linear-gradient(120deg, rgba(197,160,89,0.10), rgba(232,213,209,0.10), rgba(26,42,29,0.06));
      filter: blur(18px);
      opacity:0.9;
      animation: gardenDrift 18s ease-in-out infinite;
      transform: translate3d(0,0,0);
    }
    .garden-bg::after{
      content:"";
      position:absolute; inset:0;
      background-image:url("https://www.transparenttextures.com/patterns/natural-paper.png");
      opacity:0.55;
      mix-blend-mode:multiply;
    }
    @keyframes gardenDrift{
      0%{transform:translate(-4%,-2%) rotate(-2deg);}
      50%{transform:translate(4%,2%) rotate(2deg);}
      100%{transform:translate(-4%,-2%) rotate(-2deg);}
    }

    /* =========================
       SYMBOLIC VISUAL: GOLD MOTES
       ========================= */
    .motes{
      position:fixed; inset:0;
      z-index:2;
      pointer-events:none;
      overflow:hidden;
      opacity: 0.85;
    }
    .mote{
      position:absolute;
      width: 8px; height: 8px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.75), rgba(197,160,89,0.45) 45%, rgba(197,160,89,0.10) 70%, transparent 75%);
      filter: blur(0.2px);
      animation: moteFloat linear infinite;
      opacity: 0.8;
      box-shadow: 0 0 0 1px rgba(197,160,89,0.08);
      transform: translate3d(0,0,0);
    }
    @keyframes moteFloat{
      0%   { transform: translate3d(var(--x), 110vh, 0) scale(var(--s)); opacity: 0; }
      15%  { opacity: 0.7; }
      85%  { opacity: 0.6; }
      100% { transform: translate3d(var(--x2), -15vh, 0) scale(var(--s)); opacity: 0; }
    }

    .vignette{
      position:fixed; inset:0;
      pointer-events:none; z-index:5;
      background: radial-gradient(circle, transparent 50%, rgba(26,42,29,0.10));
    }

    /* Corner filigree */
    .filigree{
      position: fixed;
      width: min(440px, 55vw);
      opacity: 0.12;
      pointer-events:none;
      z-index: 3;
      mix-blend-mode: multiply;
      filter: blur(0.1px);
    }
    .filigree.tl{ top:-110px; left:-120px; transform: rotate(18deg); }
    .filigree.br{ bottom:-110px; right:-120px; transform: rotate(198deg); }

    /* =========================
       HEADERS
       ========================= */
    .isa-tag{
      font-size:0.6rem;
      letter-spacing:3px;
      margin-bottom:8px;
      opacity:0.7;
      text-transform:uppercase;
    }
    h1.main-title{
      font-family:'Pinyon Script', cursive;
      font-size:clamp(3rem, 12vw, 6rem);
      color:var(--gold);
      margin:0;
      line-height:1.1;
    }
    .sub-theme{
      font-family:'Playfair Display', serif;
      font-size:clamp(0.7rem, 2vw, 1rem);
      letter-spacing:clamp(4px,1vw,10px);
      text-transform:uppercase;
      margin-bottom: clamp(10px, 2vh, 18px);
    }

    /* =========================
       OPENING LINE (polished)
       ========================= */
    .opening-line{
      margin: 12px auto 16px;
      max-width: 720px;
      font-family: 'Playfair Display', serif;
      font-size: clamp(1.1rem, 3.4vw, 1.6rem);
      line-height: 1.45;
      font-style: italic;
      color: rgba(26,42,29,0.9);
    }
    .opening-soft{
      display:block;
      margin-top: 6px;
      opacity: 0.8;
    }

    /* =========================
       RITUAL BAR
       ========================= */
    .ritual-bar{
      width:min(820px, 96vw);
      margin: 10px auto 12px;
      border:1px solid rgba(197,160,89,0.35);
      border-radius: 999px;
      background: rgba(255,255,255,0.45);
      backdrop-filter: blur(5px);
      padding:10px 12px;
      box-sizing:border-box;
      position:relative;
      overflow:hidden;
    }
    .ritual-bar::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(197,160,89,0.12), rgba(26,42,29,0.08), rgba(232,213,209,0.10));
      opacity:0.75;
      pointer-events:none;
    }
    .steps{
      position:relative;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .step{
      display:flex;
      gap:8px;
      align-items:center;
      min-width: 0;
      opacity:0.55;
      transition: opacity .25s ease;
    }
    .step.active{ opacity:1; }
    .step-dot{
      width:10px; height:10px; border-radius:999px;
      border:1px solid rgba(197,160,89,0.55);
      background: rgba(197,160,89,0.18);
      flex:0 0 auto;
    }
    .step.active .step-dot{ background: rgba(197,160,89,0.9); }
    .step-label{
      font-size:0.58rem;
      letter-spacing:2px;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* =========================
       TOKEN TOP
       ========================= */
    .token-top{
      width:min(900px, 96vw);
      margin: 0 auto 10px;
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .token-badge{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 14px;
      border:1px solid rgba(197,160,89,0.55);
      border-radius:999px;
      background: rgba(255,255,255,0.55);
      backdrop-filter: blur(4px);
      letter-spacing:2px;
      text-transform:uppercase;
      font-size:0.62rem;
      opacity:0.92;
    }
    .token-dots{ display:inline-flex; gap:6px; }
    .dot{
      width:10px; height:10px;
      border-radius:999px;
      border:1px solid rgba(197,160,89,0.55);
      background: rgba(197,160,89,0.18);
    }
    .dot.filled{ background: rgba(197,160,89,0.85); }

    /* =========================
       TRAIT GRID
       ========================= */
    .trait-grid{
      width: min(920px, 96vw);
      margin: 0 auto;
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:10px;
      padding:10px;
      box-sizing:border-box;
    }
    @media (max-width: 900px){ .trait-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }

    .trait{
      background: rgba(255,255,255,0.55);
      border:1px solid rgba(197,160,89,0.55);
      border-radius:14px;
      padding:14px 14px 12px;
      text-align:left;
      cursor:pointer;
      transition: transform .18s ease, border-color .18s ease, box-shadow .18s ease;
      backdrop-filter: blur(4px);
      position:relative;
      overflow:hidden;
      min-height: 102px;
    }
    .trait:hover{ transform: translateY(-2px); border-color: var(--gold); }
    .trait::after{
      content:"";
      position:absolute; inset:10px;
      border:0.8px solid rgba(197,160,89,0.28);
      border-radius:10px;
      pointer-events:none;
      opacity:0.95;
    }
    .trait-title{
      font-family:'Playfair Display', serif;
      font-size:1.02rem;
      line-height:1.22;
      letter-spacing:0.1px;
    }
    .trait-sub{
      margin-top:6px;
      font-size:0.62rem;
      letter-spacing:2px;
      text-transform:uppercase;
      opacity:0.72;
      line-height:1.35;
    }
    .trait-meter{ margin-top:10px; display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .trait-count{ font-size:0.6rem; letter-spacing:2px; text-transform:uppercase; opacity:0.78; }

    .pips{ display:inline-flex; gap:6px; }
    .pip{
      width:12px; height:12px;
      border-radius:999px;
      border:1px solid rgba(26,42,29,0.25);
      background: rgba(26,42,29,0.06);
    }
    .pip.on{ background: rgba(26,42,29,0.75); border-color: rgba(26,42,29,0.25); }

    /* =========================
       BUTTONS
       ========================= */
    .btn-group{
      margin-top: 14px;
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .btn{
      background:none;
      border:1px solid var(--gold);
      padding:10px 18px;
      font-family:'Lato', sans-serif;
      text-transform:uppercase;
      letter-spacing:2px;
      font-size:0.7rem;
      cursor:pointer;
      transition:0.3s;
      backdrop-filter: blur(4px);
      flex: 1 1 auto;
      min-width: 150px;
      max-width: 260px;
      border-radius: 10px;
    }
    .btn-save{ background: var(--gold); color:#fff; }
    .btn-save:hover{ background: var(--deep-green); border-color: var(--deep-green); }
    .btn:disabled{ opacity:0.5; cursor:not-allowed; }

    .tiny-note{
      font-size:0.62rem;
      opacity:0.62;
      letter-spacing:1px;
      margin-top:10px;
      line-height:1.35;
    }

    /* =========================
       RECOGNITION PANEL
       ========================= */
    .panel{
      width: min(760px, 94vw);
      margin: 0 auto;
      border: 1px solid rgba(197,160,89,0.35);
      border-radius: 16px;
      background: rgba(255,255,255,0.55);
      backdrop-filter: blur(6px);
      padding: 18px 16px;
      box-sizing: border-box;
      position: relative;
      overflow: hidden;
    }
    .panel::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(900px 500px at 20% 20%, rgba(197,160,89,0.10), transparent 60%),
        radial-gradient(700px 450px at 80% 50%, rgba(232,213,209,0.12), transparent 60%);
      opacity:0.9;
      pointer-events:none;
    }
    .panel-inner{ position:relative; }
    .recognition-line{
      font-family: 'Playfair Display', serif;
      font-size: clamp(1.1rem, 3.4vw, 1.6rem);
      line-height: 1.4;
      font-style: italic;
      color: var(--ink);
      margin: 10px 0 10px;
    }
    .countdown{
      margin-top: 8px;
      font-size: 0.62rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      opacity: 0.68;
    }
    .bar{
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: rgba(26,42,29,0.08);
      overflow: hidden;
      border: 1px solid rgba(26,42,29,0.08);
      margin-top: 10px;
    }
    .bar > div{
      height: 100%;
      width: 0%;
      background: rgba(26,42,29,0.68);
      transition: width .2s linear;
    }

    /* =========================
       RESULT
       ========================= */
    #result-screen{ display:none; opacity:0; transition: opacity .35s ease; }
    #capture-frame{
      background:#fff;
      padding: clamp(28px, 5vw, 56px) clamp(18px, 4vw, 38px);
      width: 92vw;
      max-width: 540px;
      margin: 0 auto;
      position: relative;
      box-sizing: border-box;
      border: 1px solid rgba(197,160,89,0.20);
      box-shadow: 0 30px 60px rgba(0,0,0,0.05);
      background-image: url("https://www.transparenttextures.com/patterns/paper-fibers.png");
    }
    #capture-frame::before{
      content:"";
      position:absolute;
      inset: 15px;
      border: 0.5px solid var(--gold);
      pointer-events:none;
    }

    .result-isa{
      font-size:0.55rem;
      letter-spacing:4px;
      text-transform:uppercase;
      color: var(--gold);
      display:block;
      margin-bottom: 10px;
    }
    .result-theme{
      font-family:'Pinyon Script', cursive;
      font-size: 2.7rem;
      color: var(--deep-green);
      margin: 0 0 8px 0;
      line-height: 1;
    }

    .pill-row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:center;
      margin-top: 10px;
    }
    .pill{
      font-size:0.55rem;
      letter-spacing:2px;
      text-transform:uppercase;
      padding: 8px 10px;
      border: 1px solid rgba(197,160,89,0.45);
      border-radius: 999px;
      background: rgba(255,255,255,0.55);
    }

    .front-line{
      font-family:'Playfair Display', serif;
      font-size: clamp(1.15rem, 4vw, 1.55rem);
      line-height: 1.35;
      margin: 18px 0 12px;
      font-style: italic;
      color: rgba(26,42,29,0.88);
    }

    .section{
      text-align:left;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 0.5px solid rgba(0,0,0,0.09);
    }
    .sec-label{
      font-size:0.52rem;
      letter-spacing:2px;
      text-transform:uppercase;
      color: var(--gold);
      display:block;
      margin-bottom: 6px;
    }

    .articulation{
      font-family:'Playfair Display', serif;
      font-size: 1.05rem;
      line-height: 1.65;
    }

    .sec-body.small{
      font-family:'Lato', sans-serif;
      font-size: 0.88rem;
      opacity: 0.92;
      line-height: 1.6;
    }

    .counsel-box{
      margin-top: 8px;
      padding: 14px 14px;
      border-radius: 12px;
      border: 1px solid rgba(197,160,89,0.55);
      background: rgba(197,160,89,0.08);
      position: relative;
    }
    .counsel-box::before{
      content:"";
      position:absolute;
      top: 10px; right: 10px;
      width: 12px; height: 12px;
      border-radius: 999px;
      background: rgba(197,160,89,0.85);
      box-shadow: 0 0 0 4px rgba(197,160,89,0.14);
    }
    .counsel{
      font-family:'Playfair Display', serif;
      font-size: 1.02rem;
      line-height: 1.55;
    }

    /* =========================
       SOUND BUTTON
       ========================= */
    .btn-sound{
      border-color: rgba(197,160,89,0.65);
      color: var(--deep-green);
      background: rgba(255,255,255,0.45);
    }
    .btn-sound.active{
      background: rgba(26,42,29,0.85);
      color:#fff;
      border-color: rgba(26,42,29,0.85);
    }
  </style>
</head>

<body>
  <div class="garden-bg"></div>
  <div class="motes" id="motes"></div>
  <div class="vignette"></div>

  <!-- Filigree SVG (symbolic ornament) -->
  <svg class="filigree tl" viewBox="0 0 600 600" aria-hidden="true">
    <defs>
      <linearGradient id="fg" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0" stop-color="#1a2a1d" stop-opacity="0.75"/>
        <stop offset="1" stop-color="#c5a059" stop-opacity="0.75"/>
      </linearGradient>
    </defs>
    <path d="M80 210 C120 110 220 70 310 90 C390 108 440 160 430 230
             C420 290 360 330 300 320 C230 310 210 250 235 215
             C260 180 320 178 338 206 C356 235 330 260 308 257
             C285 254 280 230 295 220" fill="none" stroke="url(#fg)" stroke-width="6" opacity="0.85"/>
    <path d="M120 360 C160 300 220 260 290 270 C360 280 400 330 390 395
             C380 450 320 485 260 470 C200 455 180 400 205 365" fill="none" stroke="url(#fg)" stroke-width="5" opacity="0.55"/>
    <circle cx="120" cy="220" r="10" fill="#c5a059" opacity="0.55"/>
    <circle cx="410" cy="235" r="8" fill="#1a2a1d" opacity="0.45"/>
    <circle cx="205" cy="368" r="7" fill="#c5a059" opacity="0.45"/>
  </svg>

  <svg class="filigree br" viewBox="0 0 600 600" aria-hidden="true">
    <defs>
      <linearGradient id="fg2" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0" stop-color="#1a2a1d" stop-opacity="0.75"/>
        <stop offset="1" stop-color="#c5a059" stop-opacity="0.75"/>
      </linearGradient>
    </defs>
    <path d="M80 210 C120 110 220 70 310 90 C390 108 440 160 430 230
             C420 290 360 330 300 320 C230 310 210 250 235 215
             C260 180 320 178 338 206 C356 235 330 260 308 257
             C285 254 280 230 295 220" fill="none" stroke="url(#fg2)" stroke-width="6" opacity="0.85"/>
    <path d="M120 360 C160 300 220 260 290 270 C360 280 400 330 390 395
             C380 450 320 485 260 470 C200 455 180 400 205 365" fill="none" stroke="url(#fg2)" stroke-width="5" opacity="0.55"/>
    <circle cx="120" cy="220" r="10" fill="#c5a059" opacity="0.55"/>
    <circle cx="410" cy="235" r="8" fill="#1a2a1d" opacity="0.45"/>
    <circle cx="205" cy="368" r="7" fill="#c5a059" opacity="0.45"/>
  </svg>

  <!-- ✅ FIXED STRUCTURE: wrappers restored -->
  <div id="app-container">
    <div id="ritual-screen">

      <p class="isa-tag">ISA Chulalongkorn Presents</p>
      <h1 class="main-title">Heart to Heart</h1>
      <p class="sub-theme">Love is Learned.</p>

      <!-- ✅ polished opening -->
      <p class="opening-line">
        You’re not bad at love.
        <span class="opening-soft">You learned it from what you lived.</span>
      </p>

      <div class="ritual-bar" aria-label="Ritual progress">
        <div class="steps">
          <div class="step active" id="stepToken"><span class="step-dot"></span><span class="step-label">Tokens</span></div>
          <div class="step" id="stepRecognize"><span class="step-dot"></span><span class="step-label">Recognition</span></div>
          <div class="step" id="stepArticulate"><span class="step-dot"></span><span class="step-label">Articulation</span></div>
          <div class="step" id="stepCounsel"><span class="step-dot"></span><span class="step-label">Counsel</span></div>
        </div>
      </div>

      <!-- TOKEN SCREEN -->
      <div id="token-screen">
        <p style="margin: 6px 0 6px; font-size: 0.72rem; letter-spacing: 3px; text-transform: uppercase; opacity:0.75;">
          Spend 3 tokens on traits that feel like you
        </p>
        <p class="tiny-note" style="margin-top:6px;">Not a test. Not fate. Just recognition.</p>

        <div class="token-top">
          <div class="token-badge">
            <span>Tokens left</span>
            <span class="token-dots" id="tokenDots"></span>
          </div>
          <button class="btn" id="tokenClear" type="button">Clear</button>
          <button class="btn btn-save" id="beginRecognition" type="button" disabled>Begin Recognition</button>
          <button class="btn btn-sound active" id="soundBtn" type="button">Sound: On</button>
        </div>

        <div class="trait-grid" id="traitGrid"></div>
        <p class="tiny-note" id="tokenStatus"></p>
      </div>

      <!-- RECOGNITION SCREEN -->
      <div id="recognition-screen" style="display:none;">
        <div class="panel">
          <div class="panel-inner">
            <p style="margin: 0; font-size: 0.62rem; letter-spacing: 3px; text-transform: uppercase; opacity:0.75;">Recognition</p>
            <div class="recognition-line" id="recognitionLine">“Love is learned before it is chosen.”</div>
            <div class="countdown" id="countdownText">Continue unlocks in 3s</div>
            <div class="bar" aria-hidden="true"><div id="countBar"></div></div>

            <div class="btn-group" style="margin-top:14px;">
              <button class="btn" id="backToTokens" type="button">Back</button>
              <button class="btn btn-save" id="continueToSlip" type="button" disabled>Continue</button>
            </div>
            <p class="tiny-note">Take what resonates, leave what doesn’t.</p>
          </div>
        </div>
      </div>

    </div><!-- /#ritual-screen -->

    <!-- RESULT SCREEN -->
    <div id="result-screen">
      <div id="capture-frame">
        <span class="result-isa">ISA Chulalongkorn</span>
        <h2 class="result-theme">Heart to Heart</h2>

        <div class="pill-row">
          <span class="pill" id="pill-primary">House: —</span>
          <span class="pill" id="pill-secondary">Secondary: —</span>
          <span class="pill" id="pill-sig">Seal: —</span>
        </div>

        <div class="front-line" id="frontLine"></div>

        <div class="section">
          <span class="sec-label">Articulation</span>
          <div class="articulation" id="articulationText"></div>
        </div>

        <div class="section">
          <span class="sec-label">House Analysis</span>
          <div class="sec-body small" id="houseText"></div>
        </div>

        <div class="section">
          <span class="sec-label">Context</span>
          <div class="sec-body small" id="contextText"></div>
        </div>

        <div class="section">
          <span class="sec-label">Counsel meant for you</span>
          <div class="counsel-box" id="counselBox">
            <div class="counsel" id="counselText"></div>
          </div>
        </div>
      </div>

      <div class="btn-group">
        <button class="btn" onclick="location.reload()">Reset</button>
        <button class="btn btn-save" onclick="saveImage()">Save Picture</button>
        <button class="btn btn-sound active" id="soundBtn2" type="button">Sound: On</button>
      </div>
      <p class="tiny-note">Saved to your downloads folder</p>
    </div>

  </div><!-- /#app-container -->

  <script>
    /* =========================
       GOLD MOTES
       ========================= */
    const motesHost = document.getElementById("motes");
    function spawnMotes(count = 18){
      motesHost.innerHTML = "";
      for(let i=0;i<count;i++){
        const m = document.createElement("div");
        m.className = "mote";
        const x = Math.random() * 100;
        const x2 = Math.max(0, Math.min(100, x + (Math.random()*18 - 9)));
        const dur = 12 + Math.random() * 14;
        const delay = Math.random() * 8;
        const s = (0.55 + Math.random() * 1.2).toFixed(2);

        m.style.setProperty("--x", x + "vw");
        m.style.setProperty("--x2", x2 + "vw");
        m.style.setProperty("--s", s);
        m.style.animationDuration = dur + "s";
        m.style.animationDelay = delay + "s";
        m.style.opacity = (0.35 + Math.random()*0.55).toFixed(2);

        const size = 6 + Math.random()*10;
        m.style.width = size + "px";
        m.style.height = size + "px";
        motesHost.appendChild(m);
      }
    }
    spawnMotes(18);
    window.addEventListener("resize", ()=> spawnMotes(window.innerWidth < 480 ? 12 : 18));

    /* =========================
       SOUND (relaxing piano ambient)
       ========================= */
    let audioCtx = null;
    let masterGain = null;
    let soundOn = true;
    let audioPrimed = false;

    let pianoLoopTimer = null;
    let pianoIsRunning = false;

    function ensureAudio() {
      if (audioCtx) return;
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      masterGain = audioCtx.createGain();
      masterGain.gain.value = 0.0001;
      masterGain.connect(audioCtx.destination);
    }

    async function primeAndApplyAudio() {
      ensureAudio();
      if (audioCtx.state === "suspended") {
        try { await audioCtx.resume(); } catch (e) {}
      }
      audioPrimed = true;

      const now = audioCtx.currentTime;
      masterGain.gain.cancelScheduledValues(now);
      masterGain.gain.setValueAtTime(masterGain.gain.value, now);
      masterGain.gain.exponentialRampToValueAtTime(soundOn ? 0.55 : 0.0001, now + 0.12);

      updateSoundButtons();
      if (soundOn && !pianoIsRunning) startPianoAmbience();
    }

    function setSound(on) {
      soundOn = on;
      if (!audioPrimed || !audioCtx || !masterGain) { updateSoundButtons(); return; }

      const now = audioCtx.currentTime;
      masterGain.gain.cancelScheduledValues(now);
      masterGain.gain.setValueAtTime(masterGain.gain.value, now);
      masterGain.gain.exponentialRampToValueAtTime(on ? 0.55 : 0.0001, now + 0.12);

      updateSoundButtons();
      if (on) startPianoAmbience();
      else stopPianoAmbience();
    }

    function toggleSound() { setSound(!soundOn); }

    function updateSoundButtons() {
      const label = soundOn ? "Sound: On" : "Sound: Off";
      const btns = [document.getElementById("soundBtn"), document.getElementById("soundBtn2")].filter(Boolean);
      btns.forEach(b => {
        b.textContent = label;
        b.classList.toggle("active", soundOn);
      });
    }

    /* Autostart on first user gesture (Safari requirement) */
    (function bindAutoStart() {
      const once = async () => {
        await primeAndApplyAudio();
        window.removeEventListener("pointerdown", once);
        window.removeEventListener("keydown", once);
      };
      window.addEventListener("pointerdown", once);
      window.addEventListener("keydown", once);
    })();

    /* Bind sound buttons (ONLY ONCE) */
    document.getElementById("soundBtn")?.addEventListener("click", (e) => { e.stopPropagation(); toggleSound(); });

    /* -------------------------
       Felt-piano note synth
       ------------------------- */
    function playPianoNote(freq, { when=0, dur=1.8, vel=0.6, pan=0 } = {}) {
      if (!audioCtx || !audioPrimed || !soundOn) return;
      const t0 = audioCtx.currentTime + when;

      const osc = audioCtx.createOscillator();
      osc.type = "triangle";
      osc.frequency.setValueAtTime(freq, t0);

      const click = audioCtx.createOscillator();
      click.type = "sine";
      click.frequency.setValueAtTime(freq * 2.0, t0);

      const g = audioCtx.createGain();
      const peak = 0.08 * vel;

      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(peak, t0 + 0.01);
      g.gain.exponentialRampToValueAtTime(peak * 0.35, t0 + 0.18);
      g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);

      const filter = audioCtx.createBiquadFilter();
      filter.type = "lowpass";
      filter.frequency.setValueAtTime(1800 + vel * 1200, t0);
      filter.Q.setValueAtTime(0.8, t0);

      const delay = audioCtx.createDelay();
      delay.delayTime.setValueAtTime(0.14, t0);

      const fb = audioCtx.createGain();
      fb.gain.setValueAtTime(0.22, t0);

      const wet = audioCtx.createGain();
      wet.gain.setValueAtTime(0.35, t0);

      const dry = audioCtx.createGain();
      dry.gain.setValueAtTime(0.9, t0);

      const panner = audioCtx.createStereoPanner ? audioCtx.createStereoPanner() : null;
      if (panner) panner.pan.setValueAtTime(Math.max(-1, Math.min(1, pan)), t0);

      osc.connect(filter);
      click.connect(filter);

      filter.connect(dry);
      dry.connect(g);

      filter.connect(delay);
      delay.connect(fb);
      fb.connect(delay);
      delay.connect(wet);
      wet.connect(g);

      if (panner) { g.connect(panner); panner.connect(masterGain); }
      else { g.connect(masterGain); }

      osc.start(t0);
      click.start(t0);

      osc.stop(t0 + dur + 0.05);
      click.stop(t0 + 0.03);
    }

    const CHORDS = [
      [293.66, 369.99, 440.00],
      [392.00, 493.88, 587.33],
      [246.94, 293.66, 369.99],
      [220.00, 293.66, 329.63],
    ];

    function startPianoAmbience() {
      if (pianoIsRunning) return;
      pianoIsRunning = true;

      let step = 0;
      const tick = () => {
        if (!soundOn || !audioPrimed || !audioCtx) return;
        const chord = CHORDS[step % CHORDS.length];
        const basePan = -0.25 + Math.random() * 0.5;
        const vel = 0.45 + Math.random() * 0.25;

        playPianoNote(chord[0] / 2, { when: 0.00, dur: 2.2, vel: vel * 0.65, pan: basePan * 0.6 });
        playPianoNote(chord[0],     { when: 0.05, dur: 1.8, vel: vel,        pan: basePan });
        playPianoNote(chord[1],     { when: 0.32, dur: 1.6, vel: vel * 0.90, pan: basePan * 0.8 });
        playPianoNote(chord[2],     { when: 0.62, dur: 1.4, vel: vel * 0.85, pan: basePan * 0.6 });

        step++;
        pianoLoopTimer = setTimeout(tick, 2400);
      };
      tick();
    }

    function stopPianoAmbience() {
      pianoIsRunning = false;
      if (pianoLoopTimer) { clearTimeout(pianoLoopTimer); pianoLoopTimer = null; }
    }

    function softChime(type = "place") {
      if (!audioCtx || !audioPrimed || !soundOn) return;
      const map = { place:[659.25,880.0], gate:[523.25,659.25], reveal:[392.0,523.25] };
      const seq = map[type] || map.place;
      playPianoNote(seq[0], { when: 0.00, dur: 0.55, vel: 0.35, pan: -0.05 });
      playPianoNote(seq[1], { when: 0.08, dur: 0.60, vel: 0.30, pan:  0.08 });
    }

    /* =========================
       RITUAL DATA
       ========================= */
    const teachers = {
      family: { label:"House of Kin",
        analysis:"This House learns love through responsibility, harmony, and belonging. It values steadiness, care, and the quiet work of staying.",
        bg:"#f3eddc",
        slips:[
          { pattern:"You protect closeness by staying.",
            articulation:"When love is learned as responsibility, devotion can become endurance—staying becomes the proof.",
            context:"In many family-centered settings, emotions are managed to keep peace. Needs often become indirect requests.",
            counsel:"Name one need plainly, kindly, and early. Clarity is not disrespect."
          },
          { pattern:"You keep peace by shrinking needs.",
            articulation:"When harmony is the rule, wanting more can feel like a threat—so you become easy to live with, not fully known.",
            context:"High-context communication rewards restraint. Over time, silence can turn into quiet resentment.",
            counsel:"Let your needs exist in daylight. Start small: one concrete request."
          },
          { pattern:"You manage love like a room’s temperature.",
            articulation:"If moods mattered growing up, you may track tension instinctively—peace becomes the metric of safety.",
            context:"Families teach invisible emotional rules: who can speak, when, and how.",
            counsel:"Practice gentle honesty: one true sentence before you disappear."
          }
        ]
      },
      media: { label:"House of Theatre",
        analysis:"This House learns love through stories and intensity. It seeks meaning in spark, narrative, and emotional momentum.",
        bg:"#fce3e3",
        slips:[
          { pattern:"You read intensity as truth.",
            articulation:"When romance is learned through stories, adrenaline can look like destiny—fast feelings feel final.",
            context:"Narratives compress time and reward high emotion. Real intimacy grows through repetition and reliability.",
            counsel:"Slow is not a lack of love. Let consistency be attractive."
          },
          { pattern:"Calm feels suspicious.",
            articulation:"If love is taught as a storyline, quiet can feel like emptiness—so peace looks like ‘nothing is happening.’",
            context:"Modern romance often frames conflict as passion. Stable attachment often feels ordinary and safe.",
            counsel:"Don’t chase adrenaline to prove love. Ask: do I feel safe here?"
          },
          { pattern:"You confuse chemistry with compatibility.",
            articulation:"Stories romanticize turbulence. But intensity can be chemistry without kindness, repair, or alignment.",
            context:"Some cultures also glorify suffering as proof. In practice, peace is a love language too.",
            counsel:"Choose peace on purpose. Love should not require crisis to feel real."
          }
        ]
      },
      religion: { label:"House of Meaning",
        analysis:"This House learns love through values, devotion, and moral care. It treats love as practice—something you do, not only feel.",
        bg:"#fcfaf7",
        slips:[
          { pattern:"You take love seriously—beautifully.",
            articulation:"When love is shaped by values, commitment can be an ethic—care becomes a daily practice.",
            context:"Community ethics can strengthen loyalty. Sometimes the pressure to be ‘good’ makes normal conflict feel like failure.",
            counsel:"Devotion should include tenderness toward yourself. Imperfection doesn’t cancel worth."
          },
          { pattern:"You fear disappointing people.",
            articulation:"When love is linked to goodness, boundaries can feel like selfishness—so you over-carry expectations.",
            context:"Belonging is powerful. Shame-based belonging can silently shape how you ask for care.",
            counsel:"Let values guide you—not shame. You can be kind and still be clear."
          },
          { pattern:"You hold desire and duty at once.",
            articulation:"When love has communal meaning, you may feel torn between personal longing and responsibility.",
            context:"Navigating love across expectations is a cultural task, not personal weakness.",
            counsel:"Choose in alignment with your values—without using fear as your compass."
          }
        ]
      },
      school: { label:"House of Measure",
        analysis:"This House learns love through performance, comparison, and belonging. It seeks certainty, progress, and signs of being chosen.",
        bg:"#e0f0f5",
        slips:[
          { pattern:"You grade love like an exam.",
            articulation:"When safety comes from ‘getting it right,’ you may analyze love for certainty—signals become evidence.",
            context:"High-pressure environments train comparison. Uncertainty becomes emotionally expensive.",
            counsel:"Ask directly once. One honest question can save 100 spirals."
          },
          { pattern:"You feel behind.",
            articulation:"When life is measured in milestones, love becomes another timeline—labels can overshadow connection.",
            context:"Peer environments shape self-worth. ‘Keeping up’ becomes a hidden rule even in intimacy.",
            counsel:"Stop grading love. Focus on growth, not speed."
          },
          { pattern:"You perform to be chosen.",
            articulation:"If belonging was conditional, you may earn love through competence—being impressive becomes protection.",
            context:"Social hierarchies teach people to trade authenticity for acceptance.",
            counsel:"Practice receiving without proving. Let care land."
          }
        ]
      },
      internet: { label:"House of Distance",
        analysis:"This House learns love through attention, trends, and detachment. It values control, optionality, and protecting dignity.",
        bg:"#e8e1f5",
        slips:[
          { pattern:"You leave first to stay safe.",
            articulation:"When love is mediated by endless options, distance can feel like dignity—exiting becomes protection.",
            context:"Attention economies normalize quick exits and fear of looking ‘too much.’",
            counsel:"Leave loudly—one clear sentence is kinder than disappearing."
          },
          { pattern:"You speak in hints.",
            articulation:"When love is learned through signals—timing, likes, silence—needs can become indirect tests.",
            context:"High-context signaling works online, but misfires across personalities and cultures.",
            counsel:"Say one thing plainly. Directness is not desperation."
          },
          { pattern:"Your feelings feel ‘not enough.’",
            articulation:"When life is curated, normal emotion can feel small—so you doubt your quiet love.",
            context:"Online comparison rewards extremes. Real intimacy often looks ordinary and steady.",
            counsel:"Trust your quiet feelings. You don’t need to be loud to be real."
          }
        ]
      }
    };

    const recognitionLines = [
      "“Love is learned before it is chosen.”",
      "“Most patterns began as protection.”",
      "“What kept you safe once still guides you.”",
      "“This is not fate. It is recognition.”",
      "“You are not bad at love. You are trained by it.”"
    ];

    const TRAITS = [
      { id:"fast",  title:"I fall too fast.", sub:"speed • spark • rush", w:{ media:2, internet:1 } },
      { id:"numb",  title:"I don’t feel enough.", sub:"muted • small • numb", w:{ internet:2, media:1 } },
      { id:"leave", title:"I leave first.", sub:"exit • control • safety", w:{ internet:2, family:1 } },
      { id:"guilt", title:"I feel guilty wanting more.", sub:"need • guilt • harmony", w:{ family:2, religion:1 } },
      { id:"peace", title:"I prioritize peace over truth.", sub:"quiet • restraint • harmony", w:{ family:2, school:1 } },
      { id:"think", title:"I overthink signals.", sub:"analysis • certainty • fear", w:{ school:2, media:1 } },
      { id:"prove", title:"I perform to be chosen.", sub:"earn • impress • belong", w:{ school:2, family:1 } },
      { id:"duty",  title:"I take love seriously.", sub:"meaning • devotion • care", w:{ religion:2, family:1 } }
    ];

    /* UI REFS */
    const tokenScreen = document.getElementById("token-screen");
    const recognitionScreen = document.getElementById("recognition-screen");
    const traitGrid = document.getElementById("traitGrid");

    const tokenDots = document.getElementById("tokenDots");
    const tokenStatus = document.getElementById("tokenStatus");
    const tokenClearBtn = document.getElementById("tokenClear");
    const beginRecognitionBtn = document.getElementById("beginRecognition");

    const backToTokensBtn = document.getElementById("backToTokens");
    const continueToSlipBtn = document.getElementById("continueToSlip");

    const recognitionLineEl = document.getElementById("recognitionLine");
    const countdownTextEl = document.getElementById("countdownText");
    const countBarEl = document.getElementById("countBar");

    const stepToken = document.getElementById("stepToken");
    const stepRecognize = document.getElementById("stepRecognize");
    const stepArticulate = document.getElementById("stepArticulate");
    const stepCounsel = document.getElementById("stepCounsel");

    /* STATE */
    let tokensTotal = 3;
    let tokensLeft = 3;

    let traitTokens = Object.fromEntries(TRAITS.map(t => [t.id, 0]));
    let scores = { family:0, media:0, religion:0, school:0, internet:0 };
    let primaryKey = null;
    let secondaryKey = null;

    let recognitionTimer = null;

    function setStep(active){
      [stepToken, stepRecognize, stepArticulate, stepCounsel].forEach(s=>s.classList.remove("active"));
      if(active === "token") stepToken.classList.add("active");
      if(active === "recognition") stepRecognize.classList.add("active");
      if(active === "articulation") stepArticulate.classList.add("active");
      if(active === "counsel") stepCounsel.classList.add("active");
    }

    function renderTokenDots(){
      tokenDots.innerHTML = "";
      for(let i=0;i<tokensTotal;i++){
        const d = document.createElement("span");
        d.className = "dot" + (i < tokensLeft ? " filled" : "");
        tokenDots.appendChild(d);
      }
    }

    function recomputeScores(){
      scores = { family:0, media:0, religion:0, school:0, internet:0 };

      for(const tr of TRAITS){
        const c = traitTokens[tr.id] || 0;
        if(c <= 0) continue;
        for(const k of Object.keys(tr.w)){
          scores[k] += c * tr.w[k];
        }
      }

      const order = ["family","media","religion","school","internet"];
      const arr = order.map(k => ({k, n: scores[k]}))
        .sort((a,b)=> b.n - a.n || order.indexOf(a.k) - order.indexOf(b.k));

      primaryKey = arr[0].n > 0 ? arr[0].k : null;
      secondaryKey = arr[1].n > 0 ? arr[1].k : null;

      beginRecognitionBtn.disabled = (tokensLeft !== 0);
    }

    function deterministicSlipIndex(forTeacherKey){
      const w = { fast:3, numb:5, leave:7, guilt:11, peace:13, think:17, prove:19, duty:23 };
      let h = 0;
      for(const tr of TRAITS){
        h += (traitTokens[tr.id] || 0) * w[tr.id];
      }
      return h % teachers[forTeacherKey].slips.length;
    }

    function computeSeal(){
      const w = { fast:31, numb:37, leave:41, guilt:43, peace:47, think:53, prove:59, duty:61 };
      let n = 0;
      for(const tr of TRAITS){
        n += (traitTokens[tr.id] || 0) * w[tr.id];
      }
      const seal = (n + 2026).toString(36).toUpperCase();
      return "ISA-H2H-" + seal.padStart(4,"0");
    }

    function renderTraits(){
      traitGrid.innerHTML = "";
      recomputeScores();

      TRAITS.forEach(tr=>{
        const count = traitTokens[tr.id] || 0;
        const tile = document.createElement("div");
        tile.className = "trait";
        tile.tabIndex = 0;

        const pips = Array.from({length:3}).map((_,i)=> `<span class="pip ${i < count ? "on":""}"></span>`).join("");

        tile.innerHTML = `
          <div class="trait-title">${tr.title}</div>
          <div class="trait-sub">${tr.sub}</div>
          <div class="trait-meter">
            <div class="trait-count">Tokens: ${count}</div>
            <div class="pips">${pips}</div>
          </div>
        `;

        const addToken = ()=>{
          if(tokensLeft <= 0){
            tokenStatus.textContent = "No tokens left. Begin recognition.";
            return;
          }
          traitTokens[tr.id] += 1;
          tokensLeft -= 1;

          renderTokenDots();
          renderTraits();
          softChime("place");

          tokenStatus.textContent = (tokensLeft > 0)
            ? `Token placed. ${tokensLeft} left.`
            : `Allocation complete. Proceed to recognition.`;

          if(primaryKey){
            document.body.style.backgroundColor = teachers[primaryKey].bg;
          }
        };

        tile.addEventListener("click", addToken);
        tile.addEventListener("keydown", (e)=>{
          if(e.key === "Enter" || e.key === " "){ e.preventDefault(); addToken(); }
        });

        traitGrid.appendChild(tile);
      });

      if(tokensLeft > 0){
        tokenStatus.textContent = "Spend all 3 tokens to continue.";
      }
    }

    function clearTraits(){
      traitTokens = Object.fromEntries(TRAITS.map(t => [t.id, 0]));
      tokensLeft = tokensTotal;
      primaryKey = null;
      secondaryKey = null;
      tokenStatus.textContent = "Cleared.";
      renderTokenDots();
      renderTraits();
      beginRecognitionBtn.disabled = true;
      document.body.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue("--cream").trim() || "#f8f5f0";
      setStep("token");
      softChime("gate");
    }

    tokenClearBtn.addEventListener("click", clearTraits);

    function startRecognition(){
      if(tokensLeft !== 0){
        tokenStatus.textContent = "Please spend all tokens first.";
        return;
      }
      recomputeScores();
      if(!primaryKey){
        tokenStatus.textContent = "Please select at least one trait.";
        return;
      }

      setStep("recognition");
      tokenScreen.style.display = "none";
      recognitionScreen.style.display = "block";

      const idx = deterministicSlipIndex(primaryKey) % recognitionLines.length;
      recognitionLineEl.textContent = recognitionLines[idx];

      softChime("gate");

      continueToSlipBtn.disabled = true;
      countdownTextEl.textContent = "Continue unlocks in 3s";
      countBarEl.style.width = "0%";

      const start = performance.now();
      const duration = 3000;
      if(recognitionTimer) cancelAnimationFrame(recognitionTimer);

      const tick = (now)=>{
        const elapsed = now - start;
        const p = Math.min(1, elapsed / duration);
        countBarEl.style.width = (p * 100).toFixed(0) + "%";

        const remaining = Math.max(0, (duration - elapsed) / 1000);
        if(remaining > 0.01){
          countdownTextEl.textContent = `Continue unlocks in ${Math.ceil(remaining)}s`;
          recognitionTimer = requestAnimationFrame(tick);
        } else {
          countdownTextEl.textContent = "Ready.";
          continueToSlipBtn.disabled = false;
          countBarEl.style.width = "100%";
        }
      };
      recognitionTimer = requestAnimationFrame(tick);
    }

    beginRecognitionBtn.addEventListener("click", startRecognition);

    backToTokensBtn.addEventListener("click", ()=>{
      if(recognitionTimer) cancelAnimationFrame(recognitionTimer);
      recognitionScreen.style.display = "none";
      tokenScreen.style.display = "block";
      setStep("token");
      softChime("place");
    });

    function showSlip(){
      recomputeScores();
      if(!primaryKey) return;

      const i = deterministicSlipIndex(primaryKey);
      const slip = teachers[primaryKey].slips[i];

      setStep("articulation");

      document.getElementById("ritual-screen").style.display = "none";
      const result = document.getElementById("result-screen");
      result.style.display = "block";
      requestAnimationFrame(()=> result.style.opacity = "1");

      document.getElementById("pill-primary").textContent = `House: ${teachers[primaryKey].label}`;
      document.getElementById("pill-secondary").textContent = `Secondary: ${secondaryKey ? teachers[secondaryKey].label : "—"}`;
      document.getElementById("pill-sig").textContent = `Seal: ${computeSeal()}`;

      document.getElementById("frontLine").textContent = slip.pattern;
      document.getElementById("articulationText").textContent = slip.articulation + " (Derived from the traits you selected.)";
      document.getElementById("houseText").textContent =
        teachers[primaryKey].analysis +
        (secondaryKey ? ` A secondary influence from ${teachers[secondaryKey].label} may color how this shows up.` : "");
      document.getElementById("contextText").textContent = slip.context;
      document.getElementById("counselText").textContent = slip.counsel;

      const counselBox = document.getElementById("counselBox");
      counselBox.style.opacity = "0";
      counselBox.style.transform = "translateY(6px)";
      counselBox.style.transition = "opacity .5s ease, transform .5s ease";

      softChime("reveal");
      setTimeout(()=>{
        setStep("counsel");
        counselBox.style.opacity = "1";
        counselBox.style.transform = "translateY(0)";
      }, 900);

      document.body.style.backgroundColor = teachers[primaryKey].bg;

      const b2 = document.getElementById("soundBtn2");
      if (b2 && !b2.dataset.bound) {
        b2.dataset.bound = "1";
        b2.addEventListener('click', (e) => { e.stopPropagation(); toggleSound(); });
        updateSoundButtons();
      }
    }

    continueToSlipBtn.addEventListener("click", showSlip);

    function saveImage(){
      const captureArea = document.getElementById('capture-frame');
      html2canvas(captureArea, { backgroundColor: null, scale: 2 }).then(canvas => {
        const link = document.createElement('a');
        link.download = 'HeartToHeart_ISA_ReflectionSlip.png';
        link.href = canvas.toDataURL("image/png");
        link.click();
      });
    }
    window.saveImage = saveImage;

    /* INIT */
    renderTokenDots();
    renderTraits();
    setStep("token");
    // ✅ removed duplicate soundBtn binding
  </script>
</body>
</html>
