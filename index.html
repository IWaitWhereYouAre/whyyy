<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Heart to Heart | ISA Chulalongkorn</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Lato:wght@300;400&family=Pinyon+Script&display=swap');

    :root{
      --gold:#c5a059;
      --deep-green:#1a2a1d;
      --cream:#f8f5f0;
      --blush:#e8d5d1;
      --ink: rgba(26,42,29,0.84);
    }

    html, body{
      width:100%; height:100%;
      margin:0; padding:0;
      background: var(--cream);
      overflow:hidden;
      -webkit-text-size-adjust:100%;
      touch-action:manipulation;
    }

    body{
      min-height:100svh;
      background-color:var(--cream);
      color:var(--deep-green);
      font-family:'Lato', sans-serif;
      display:flex;
      justify-content:center;
      align-items:center;
      transition: background-color 1.1s ease;
      position:relative;
    }

    #app-container{
      text-align:center;
      width:100%;
      max-width:1200px;
      padding:20px;
      z-index:10;
      box-sizing:border-box;
      position:relative;
    }

    /* =========================
       SECRET GARDEN BACKGROUND
       ========================= */
    .garden-bg{
      position:fixed; inset:0;
      z-index:0;
      pointer-events:none;
      overflow:hidden;
      background:
        radial-gradient(900px 700px at 20% 20%, rgba(197,160,89,0.14), transparent 60%),
        radial-gradient(800px 650px at 80% 30%, rgba(232,213,209,0.18), transparent 55%),
        radial-gradient(900px 700px at 40% 90%, rgba(26,42,29,0.14), transparent 55%),
        linear-gradient(120deg, rgba(248,245,240,1), rgba(248,245,240,1));
    }
    .garden-bg::before{
      content:"";
      position:absolute; inset:-40%;
      background:
        radial-gradient(circle at 20% 30%, rgba(255,255,255,0.55), transparent 55%),
        radial-gradient(circle at 70% 40%, rgba(255,255,255,0.35), transparent 60%),
        radial-gradient(circle at 50% 70%, rgba(255,255,255,0.25), transparent 65%),
        linear-gradient(120deg, rgba(197,160,89,0.08), rgba(232,213,209,0.10), rgba(26,42,29,0.06));
      filter: blur(18px);
      opacity:0.9;
      animation: gardenDrift 18s ease-in-out infinite;
      transform: translate3d(0,0,0);
    }
    .garden-bg::after{
      content:"";
      position:absolute; inset:0;
      background-image:url("https://www.transparenttextures.com/patterns/natural-paper.png");
      opacity:0.55;
      mix-blend-mode:multiply;
    }
    @keyframes gardenDrift{
      0%{transform:translate(-4%,-2%) rotate(-2deg);}
      50%{transform:translate(4%,2%) rotate(2deg);}
      100%{transform:translate(-4%,-2%) rotate(-2deg);}
    }

    /* =========================
       PETALS
       ========================= */
    .petals{ position:fixed; inset:0; z-index:2; pointer-events:none; overflow:hidden; }
    .petal{
      position:absolute; top:-10%;
      width:10px; height:16px;
      border-radius:60% 40% 60% 40%;
      background:rgba(232,213,209,0.55);
      box-shadow:0 0 0 1px rgba(197,160,89,0.08);
      filter:blur(0.15px);
      animation: fall linear infinite;
      transform:rotate(12deg);
      opacity:0.85;
    }
    @keyframes fall{
      0%{transform:translate3d(0,-20px,0) rotate(10deg);}
      100%{transform:translate3d(0,120vh,0) rotate(260deg);}
    }

    /* =========================
       BIRDS
       ========================= */
    .birds{ position:fixed; inset:0; z-index:3; pointer-events:none; overflow:hidden; opacity:0.65; filter:blur(0.1px); }
    .bird{
      position:absolute; left:0; top:0;
      width:56px; height:30px;
      opacity:0.55;
      animation: flyDiag linear infinite;
      transform: translate3d(var(--fromX), var(--fromY), 0) scale(var(--s, 1));
      will-change: transform, opacity;
    }
    @keyframes flyDiag{
      0%{transform:translate3d(var(--fromX),var(--fromY),0) scale(var(--s,1)); opacity:0;}
      10%{opacity:0.65;}
      90%{opacity:0.55;}
      100%{transform:translate3d(var(--toX),var(--toY),0) scale(var(--s,1)); opacity:0;}
    }
    .bird .wing{ transform-box:fill-box; transform-origin:center; animation: flap 0.35s ease-in-out infinite; }
    .bird .wing.right{ animation-delay:0.02s; }
    @keyframes flap{
      0%{transform:rotate(8deg) scaleY(1);}
      50%{transform:rotate(-18deg) scaleY(0.92);}
      100%{transform:rotate(8deg) scaleY(1);}
    }

    .vignette{ position:fixed; inset:0; pointer-events:none; z-index:5;
      background: radial-gradient(circle, transparent 50%, rgba(26,42,29,0.1));
    }

    /* =========================
       HEADERS
       ========================= */
    .isa-tag{
      font-size:0.6rem;
      letter-spacing:3px;
      margin-bottom:8px;
      opacity:0.7;
      text-transform:uppercase;
    }
    h1.main-title{
      font-family:'Pinyon Script', cursive;
      font-size:clamp(3rem, 12vw, 6rem);
      color:var(--gold);
      margin:0;
      line-height:1.1;
    }
    .sub-theme{
      font-family:'Playfair Display', serif;
      font-size:clamp(0.7rem, 2vw, 1rem);
      letter-spacing:clamp(4px,1vw,10px);
      text-transform:uppercase;
      margin-bottom: clamp(14px, 2.6vh, 24px);
    }

    /* =========================
       PROGRESS / RITUAL BAR
       ========================= */
    .ritual-bar{
      width:min(820px, 96vw);
      margin: 10px auto 12px;
      border:1px solid rgba(197,160,89,0.35);
      border-radius: 999px;
      background: rgba(255,255,255,0.45);
      backdrop-filter: blur(5px);
      padding:10px 12px;
      box-sizing:border-box;
      position:relative;
      overflow:hidden;
    }
    .ritual-bar::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(197,160,89,0.12), rgba(26,42,29,0.08), rgba(232,213,209,0.10));
      opacity:0.75;
      pointer-events:none;
    }
    .steps{
      position:relative;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .step{
      display:flex;
      gap:8px;
      align-items:center;
      min-width: 0;
      opacity:0.55;
      transition: opacity .25s ease;
    }
    .step.active{ opacity:1; }
    .step-dot{
      width:10px; height:10px; border-radius:999px;
      border:1px solid rgba(197,160,89,0.55);
      background: rgba(197,160,89,0.18);
      flex:0 0 auto;
    }
    .step.active .step-dot{ background: rgba(197,160,89,0.9); }
    .step-label{
      font-size:0.58rem;
      letter-spacing:2px;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* =========================
       TOKEN UI
       ========================= */
    .token-top{
      width:min(900px, 96vw);
      margin: 0 auto 10px;
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .token-badge{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 14px;
      border:1px solid rgba(197,160,89,0.55);
      border-radius:999px;
      background: rgba(255,255,255,0.55);
      backdrop-filter: blur(4px);
      letter-spacing:2px;
      text-transform:uppercase;
      font-size:0.62rem;
      opacity:0.92;
    }
    .token-dots{ display:inline-flex; gap:6px; }
    .dot{
      width:10px; height:10px;
      border-radius:999px;
      border:1px solid rgba(197,160,89,0.55);
      background: rgba(197,160,89,0.18);
    }
    .dot.filled{ background: rgba(197,160,89,0.85); }

    /* Teacher cards */
    .teacher-grid{
      width: min(920px, 96vw);
      margin: 0 auto;
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap:10px;
      padding:10px;
      box-sizing:border-box;
    }
    @media (max-width: 900px){ .teacher-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    .teacher{
      background: rgba(255,255,255,0.55);
      border:1px solid rgba(197,160,89,0.55);
      border-radius:14px;
      padding:14px 14px 12px;
      text-align:left;
      cursor:pointer;
      transition: transform .18s ease, border-color .18s ease, box-shadow .18s ease;
      backdrop-filter: blur(4px);
      position:relative;
      overflow:hidden;
      min-height: 118px;
    }
    .teacher:hover{ transform: translateY(-2px); border-color: var(--gold); }
    .teacher::after{
      content:"";
      position:absolute;
      inset:10px;
      border:0.8px solid rgba(197,160,89,0.32);
      border-radius:10px;
      pointer-events:none;
      opacity:0.9;
    }
    .t-title{
      font-family:'Playfair Display', serif;
      font-size:1.05rem;
      letter-spacing:0.2px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .t-sub{
      margin-top:6px;
      font-size:0.62rem;
      letter-spacing:2px;
      text-transform:uppercase;
      opacity:0.72;
      line-height:1.35;
    }
    .t-meter{
      margin-top:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .t-count{
      font-size:0.6rem;
      letter-spacing:2px;
      text-transform:uppercase;
      opacity:0.78;
    }
    .pips{ display:inline-flex; gap:6px; }
    .pip{
      width:12px; height:12px;
      border-radius:999px;
      border:1px solid rgba(26,42,29,0.25);
      background: rgba(26,42,29,0.06);
    }
    .pip.on{ background: rgba(26,42,29,0.75); border-color: rgba(26,42,29,0.25); }
    .t-tag{
      position:absolute;
      top:12px; right:12px;
      font-size:0.55rem;
      letter-spacing:2px;
      text-transform:uppercase;
      padding:7px 9px;
      border-radius:999px;
      background: rgba(26,42,29,0.85);
      color:#fff;
      opacity:0;
      transform: translateY(-6px);
      transition: .18s ease;
      pointer-events:none;
    }
    .teacher.leading .t-tag{ opacity:1; transform: translateY(0); }
    .teacher.locked{ opacity:0.82; }
    .teacher.locked:hover{ transform:none; }

    /* Buttons */
    .btn-group{
      margin-top: 14px;
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .btn{
      background:none;
      border:1px solid var(--gold);
      padding:10px 18px;
      font-family:'Lato', sans-serif;
      text-transform:uppercase;
      letter-spacing:2px;
      font-size:0.7rem;
      cursor:pointer;
      transition:0.3s;
      backdrop-filter: blur(4px);
      flex: 1 1 auto;
      min-width: 140px;
      max-width: 240px;
      border-radius: 10px;
    }
    .btn-save{ background: var(--gold); color:#fff; }
    .btn-save:hover{ background: var(--deep-green); border-color: var(--deep-green); }
    .btn:disabled{
      opacity:0.5;
      cursor:not-allowed;
    }

    .tiny-note{
      font-size:0.62rem;
      opacity:0.62;
      letter-spacing:1px;
      margin-top:10px;
      line-height:1.35;
    }

    /* =========================
       RECOGNITION SCREEN
       ========================= */
    .panel{
      width: min(760px, 94vw);
      margin: 0 auto;
      border: 1px solid rgba(197,160,89,0.35);
      border-radius: 16px;
      background: rgba(255,255,255,0.55);
      backdrop-filter: blur(6px);
      padding: 18px 16px;
      box-sizing: border-box;
      position: relative;
      overflow: hidden;
    }
    .panel::before{
      content:"";
      position:absolute;
      inset:0;
      background: radial-gradient(900px 500px at 20% 20%, rgba(197,160,89,0.10), transparent 60%),
                  radial-gradient(700px 450px at 80% 50%, rgba(232,213,209,0.12), transparent 60%);
      opacity:0.9;
      pointer-events:none;
    }
    .panel-inner{ position:relative; }
    .recognition-line{
      font-family: 'Playfair Display', serif;
      font-size: clamp(1.1rem, 3.4vw, 1.6rem);
      line-height: 1.4;
      font-style: italic;
      color: var(--ink);
      margin: 10px 0 10px;
    }
    .countdown{
      margin-top: 8px;
      font-size: 0.62rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      opacity: 0.68;
    }
    .bar{
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: rgba(26,42,29,0.08);
      overflow: hidden;
      border: 1px solid rgba(26,42,29,0.08);
      margin-top: 10px;
    }
    .bar > div{
      height: 100%;
      width: 0%;
      background: rgba(26,42,29,0.68);
      transition: width .2s linear;
    }

    /* =========================
       RESULT (CAPTURE FRAME)
       ========================= */
    #result-screen{ display:none; opacity:0; transition: opacity .35s ease; }
    #capture-frame{
      background:#fff;
      padding: clamp(28px, 5vw, 56px) clamp(18px, 4vw, 38px);
      width: 92vw;
      max-width: 520px;
      margin: 0 auto;
      position: relative;
      box-sizing: border-box;
      border: 1px solid rgba(197,160,89,0.20);
      box-shadow: 0 30px 60px rgba(0,0,0,0.05);
      background-image: url("https://www.transparenttextures.com/patterns/paper-fibers.png");
    }
    #capture-frame::before{
      content:"";
      position:absolute;
      inset: 15px;
      border: 0.5px solid var(--gold);
      pointer-events:none;
    }
    .result-isa{
      font-size:0.55rem;
      letter-spacing:4px;
      text-transform:uppercase;
      color: var(--gold);
      display:block;
      margin-bottom: 10px;
    }
    .result-theme{
      font-family:'Pinyon Script', cursive;
      font-size: 2.7rem;
      color: var(--deep-green);
      margin: 0 0 8px 0;
      line-height: 1;
    }
    .pill-row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:center;
      margin-top: 10px;
    }
    .pill{
      font-size:0.55rem;
      letter-spacing:2px;
      text-transform:uppercase;
      padding: 8px 10px;
      border: 1px solid rgba(197,160,89,0.45);
      border-radius: 999px;
      background: rgba(255,255,255,0.55);
    }
    .front-line{
      font-family:'Playfair Display', serif;
      font-size: clamp(1.15rem, 4vw, 1.55rem);
      line-height: 1.35;
      margin: 18px 0 12px;
      font-style: italic;
      color: rgba(26,42,29,0.88);
    }
    .section{
      text-align:left;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 0.5px solid rgba(0,0,0,0.09);
    }
    .sec-label{
      font-size:0.52rem;
      letter-spacing:2px;
      text-transform:uppercase;
      color: var(--gold);
      display:block;
      margin-bottom: 6px;
    }
    .sec-body.small{
      font-family:'Lato', sans-serif;
      font-size: 0.88rem;
      opacity: 0.92;
      line-height: 1.55;
    }
    .sec-body{
      font-family:'Playfair Display', serif;
      font-size: 0.95rem;
      line-height: 1.55;
    }
    .advice{
      font-family:'Playfair Display', serif;
      font-size: 1.02rem;
      line-height: 1.5;
    }

    /* =========================
       SOUND TOGGLE BUTTONS
       ========================= */
    .btn-sound{
      border-color: rgba(197,160,89,0.65);
      color: var(--deep-green);
      background: rgba(255,255,255,0.45);
    }
    .btn-sound.active{
      background: rgba(26,42,29,0.85);
      color:#fff;
      border-color: rgba(26,42,29,0.85);
    }
  </style>
</head>

<body>
  <div class="garden-bg"></div>
  <div class="petals" id="petals"></div>
  <div class="birds" id="birds"></div>
  <div class="vignette"></div>

  <div id="app-container">
    <div id="ritual-screen">
      <p class="isa-tag">ISA Chulalongkorn Presents</p>
      <h1 class="main-title">Heart to Heart</h1>
      <p class="sub-theme">Love Is Learned</p>

      <!-- ritual progress -->
      <div class="ritual-bar" aria-label="Ritual progress">
        <div class="steps">
          <div class="step active" id="stepToken"><span class="step-dot"></span><span class="step-label">Token</span></div>
          <div class="step" id="stepRecognize"><span class="step-dot"></span><span class="step-label">Recognition</span></div>
          <div class="step" id="stepArticulate"><span class="step-dot"></span><span class="step-label">Articulation</span></div>
          <div class="step" id="stepCounsel"><span class="step-dot"></span><span class="step-label">Counsel</span></div>
        </div>
      </div>

      <!-- TOKEN SCREEN -->
      <div id="token-screen">
        <p style="margin: 6px 0 6px; font-size: 0.72rem; letter-spacing: 3px; text-transform: uppercase; opacity:0.75;">
          Allocate 3 tokens to what shaped your idea of love
        </p>
        <p class="tiny-note" style="margin-top:6px;">
          Reflection, not prediction. No gambling. No divination. Just insight.
        </p>

        <div class="token-top">
          <div class="token-badge">
            <span>Tokens left</span>
            <span class="token-dots" id="tokenDots"></span>
          </div>
          <button class="btn" id="tokenClear" type="button">Clear</button>
          <button class="btn btn-save" id="beginRecognition" type="button" disabled>Begin Recognition</button>
          <button class="btn btn-sound active" id="soundBtn" type="button">Sound: On</button>
        </div>

        <div class="teacher-grid" id="teacherGrid"></div>
        <p class="tiny-note" id="tokenStatus"></p>
      </div>

      <!-- RECOGNITION SCREEN -->
      <div id="recognition-screen" style="display:none;">
        <div class="panel">
          <div class="panel-inner">
            <p style="margin: 0; font-size: 0.62rem; letter-spacing: 3px; text-transform: uppercase; opacity:0.75;">
              Recognition
            </p>
            <div class="recognition-line" id="recognitionLine">“Love is learned before it is chosen.”</div>
            <div class="countdown" id="countdownText">Continue unlocks in 3s</div>
            <div class="bar" aria-hidden="true"><div id="countBar"></div></div>

            <div class="btn-group" style="margin-top:14px;">
              <button class="btn" id="backToTokens" type="button">Back</button>
              <button class="btn btn-save" id="continueToSlip" type="button" disabled>Continue</button>
            </div>
            <p class="tiny-note">
              Take what resonates, leave what doesn’t.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- RESULT SCREEN -->
    <div id="result-screen">
      <div id="capture-frame">
        <span class="result-isa">ISA Chulalongkorn</span>
        <h2 class="result-theme">Heart to Heart</h2>

        <div class="pill-row">
          <span class="pill" id="pill-primary">Primary: —</span>
          <span class="pill" id="pill-secondary">Secondary: —</span>
          <span class="pill">Not a diagnosis • A lens</span>
        </div>

        <div class="front-line" id="frontLine"></div>

        <div class="section">
          <span class="sec-label">Articulation</span>
          <div class="sec-body" id="articulationText"></div>
        </div>

        <div class="section">
          <span class="sec-label">Context</span>
          <div class="sec-body small" id="contextText"></div>
        </div>

        <div class="section">
          <span class="sec-label">Counsel meant for you</span>
          <div class="sec-body advice" id="counselText"></div>
        </div>
      </div>

      <div class="btn-group">
        <button class="btn" onclick="location.reload()">Reset</button>
        <button class="btn btn-save" onclick="saveImage()">Save Picture</button>
        <button class="btn btn-sound active" id="soundBtn2" type="button">Sound: On</button>
      </div>
      <p class="tiny-note">Saved to your downloads folder</p>
    </div>
  </div>

  <script>
    /* =========================
       PETALS
       ========================= */
    const petalsHost = document.getElementById('petals');
    function spawnPetals(count = 16) {
      petalsHost.innerHTML = '';
      for (let i = 0; i < count; i++) {
        const p = document.createElement('div');
        p.className = 'petal';
        const left = Math.random() * 100;
        const dur = 10 + Math.random() * 12;
        const delay = Math.random() * 8;
        const size = 8 + Math.random() * 10;
        p.style.left = left + 'vw';
        p.style.animationDuration = dur + 's';
        p.style.animationDelay = delay + 's';
        p.style.width = size + 'px';
        p.style.height = (size * 1.5) + 'px';
        p.style.opacity = (0.45 + Math.random() * 0.45).toFixed(2);
        petalsHost.appendChild(p);
      }
    }
    spawnPetals(18);
    window.addEventListener('resize', () => spawnPetals(window.innerWidth < 480 ? 12 : 18));

    /* =========================
       SOUND (birds only)
       ========================= */
    let audioCtx = null;
    let masterGain = null;
    let soundOn = true;
    let audioPrimed = false;

    function ensureAudio() {
      if (audioCtx) return;
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      masterGain = audioCtx.createGain();
      masterGain.gain.value = 0.0001;
      masterGain.connect(audioCtx.destination);
    }

    async function primeAndApplyAudio() {
      ensureAudio();
      if (audioCtx.state === "suspended") {
        try { await audioCtx.resume(); } catch (e) {}
      }
      audioPrimed = true;
      const now = audioCtx.currentTime;
      masterGain.gain.cancelScheduledValues(now);
      masterGain.gain.setValueAtTime(masterGain.gain.value, now);
      masterGain.gain.exponentialRampToValueAtTime(soundOn ? 0.85 : 0.0001, now + 0.12);
      updateSoundButtons();
    }

    function setSound(on) {
      soundOn = on;
      if (!audioPrimed || !audioCtx || !masterGain) { updateSoundButtons(); return; }
      const now = audioCtx.currentTime;
      masterGain.gain.cancelScheduledValues(now);
      masterGain.gain.setValueAtTime(masterGain.gain.value, now);
      masterGain.gain.exponentialRampToValueAtTime(on ? 0.85 : 0.0001, now + 0.12);
      updateSoundButtons();
    }

    function toggleSound() { setSound(!soundOn); }

    function updateSoundButtons() {
      const label = soundOn ? "Sound: On" : "Sound: Off";
      const btns = [document.getElementById("soundBtn"), document.getElementById("soundBtn2")].filter(Boolean);
      btns.forEach(b => {
        b.textContent = label;
        b.classList.toggle("active", soundOn);
      });
    }

    (function bindAutoStart() {
      const once = async () => {
        await primeAndApplyAudio();
        window.removeEventListener("pointerdown", once);
        window.removeEventListener("keydown", once);
      };
      window.addEventListener("pointerdown", once);
      window.addEventListener("keydown", once);
    })();

    document.getElementById("soundBtn").addEventListener("click", (e) => { e.stopPropagation(); toggleSound(); });

    function pleasantChirp({ pan = 0, volume = 1 } = {}) {
      if (!audioCtx || !audioPrimed || !soundOn) return;

      const now = audioCtx.currentTime;
      const osc1 = audioCtx.createOscillator();
      const osc2 = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      const filter = audioCtx.createBiquadFilter();
      const panner = audioCtx.createStereoPanner ? audioCtx.createStereoPanner() : null;

      osc1.type = "sine";
      osc2.type = "triangle";

      filter.type = "bandpass";
      filter.frequency.value = 2600;
      filter.Q.value = 9;

      const base = 1350 + Math.random() * 950;
      const sweepUp = 1.30 + Math.random() * 0.30;
      const duration = 0.18 + Math.random() * 0.08;

      osc1.frequency.setValueAtTime(base, now);
      osc1.frequency.exponentialRampToValueAtTime(base * sweepUp, now + duration * 0.65);

      osc2.frequency.setValueAtTime(base * 0.985, now);
      osc2.frequency.exponentialRampToValueAtTime(base * sweepUp * 1.02, now + duration * 0.65);

      const lfo = audioCtx.createOscillator();
      const lfoGain = audioCtx.createGain();
      lfo.type = "sine";
      lfo.frequency.value = 10 + Math.random() * 3;
      lfoGain.gain.value = 14 + Math.random() * 9;
      lfo.connect(lfoGain);
      lfoGain.connect(osc1.frequency);
      lfoGain.connect(osc2.frequency);

      const peak = 0.045 * volume;
      gain.gain.setValueAtTime(0.0001, now);
      gain.gain.exponentialRampToValueAtTime(peak, now + 0.028);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + duration);

      osc1.connect(filter);
      osc2.connect(filter);

      if (panner) {
        panner.pan.setValueAtTime(Math.max(-1, Math.min(1, pan)), now);
        filter.connect(panner);
        panner.connect(gain);
      } else {
        filter.connect(gain);
      }

      gain.connect(masterGain);

      lfo.start(now);
      osc1.start(now);
      osc2.start(now);

      const stopAt = now + duration + 0.02;
      lfo.stop(stopAt);
      osc1.stop(stopAt);
      osc2.stop(stopAt);
    }

    updateSoundButtons();

    /* =========================
       BIRDS (visual + sound synced)
       ========================= */
    const birdsHost = document.getElementById('birds');

    function spawnBird() {
      if (!birdsHost) return;

      const bird = document.createElement('div');
      bird.className = 'bird';

      const mode = Math.random() > 0.5 ? "up" : "down";
      const fromX = "-25vw";
      const toX   = "120vw";

      const fromY = mode === "up" ? (65 + Math.random() * 25) + "vh" : (10 + Math.random() * 25) + "vh";
      const toY   = mode === "up" ? (8 + Math.random() * 25) + "vh"  : (55 + Math.random() * 30) + "vh";

      const dur = 9 + Math.random() * 10;
      const delay = Math.random() * 2.5;
      const scale = (0.75 + Math.random() * 0.7).toFixed(2);
      const opacity = (0.28 + Math.random() * 0.35).toFixed(2);

      bird.style.setProperty('--fromX', fromX);
      bird.style.setProperty('--toX', toX);
      bird.style.setProperty('--fromY', fromY);
      bird.style.setProperty('--toY', toY);
      bird.style.setProperty('--s', scale);

      bird.style.animationDuration = dur + "s";
      bird.style.animationDelay = delay + "s";
      bird.style.opacity = opacity;

      bird.innerHTML = `
        <svg viewBox="0 0 120 60" xmlns="http://www.w3.org/2000/svg">
          <g fill="none" stroke-linecap="round" stroke="rgba(26,42,29,0.62)">
            <path d="M58 36 Q60 34 62 36" stroke-width="3"/>
            <path class="wing left"  d="M60 36 Q40 18 18 26" stroke-width="3.2"/>
            <path class="wing right" d="M60 36 Q80 18 102 26" stroke-width="3.2"/>
          </g>
          <g fill="none" stroke-linecap="round" stroke="rgba(197,160,89,0.28)">
            <path class="wing left"  d="M60 36 Q43 22 22 28" stroke-width="2.1"/>
            <path class="wing right" d="M60 36 Q77 22 98 28" stroke-width="2.1"/>
          </g>
        </svg>
      `;

      birdsHost.appendChild(bird);

      const entryPan = -0.55 + Math.random() * 0.25;
      const midPan   = -0.10 + Math.random() * 0.20;
      const baseVol  = 0.85 + Math.random() * 0.25;

      setTimeout(() => {
        pleasantChirp({ pan: entryPan, volume: baseVol });
        if (Math.random() > 0.55) setTimeout(() => pleasantChirp({ pan: midPan, volume: baseVol * 0.92 }), (dur * 0.45) * 1000);
        if (Math.random() > 0.7)  setTimeout(() => pleasantChirp({ pan: entryPan, volume: baseVol * 0.72 }), 220 + Math.random() * 180);
      }, delay * 1000);

      setTimeout(() => bird.remove(), (dur + delay + 1) * 1000);
    }

    function startBirdFlights() {
      spawnBird();
      setInterval(() => { if (Math.random() > 0.35) spawnBird(); }, 2200);
    }
    startBirdFlights();

    /* =========================
       RITUAL DATA (NO TAROT)
       - deterministic mapping from tokens -> slip
       ========================= */
    const teachers = {
      family: {
        label: "Family",
        bg: "#f3eddc",
        sub: "care • harmony • duty",
        slips: [
          {
            pattern: "You protect closeness by staying.",
            articulation: "People who learned love through family often equate devotion with endurance—staying becomes the proof.",
            context: "In many family-centered or harmony-focused contexts, love is modeled through responsibility and sacrifice. Needs can be expressed indirectly to avoid conflict.",
            counsel: "Your counsel: name one need plainly, kindly, and early. Clarity is not disrespect."
          },
          {
            pattern: "You keep peace by shrinking needs.",
            articulation: "When love is taught as harmony, people often treat wanting more as ‘too much’—so they become easy to live with, not fully known.",
            context: "High-context environments reward emotional restraint. Over time, silence can turn into quiet resentment or withdrawal.",
            counsel: "Your counsel: let your needs exist in daylight. Start small: one concrete request."
          },
          {
            pattern: "You manage love like a room’s temperature.",
            articulation: "If you learned love in a home where moods mattered, you may track tension instinctively—peace becomes the metric of safety.",
            context: "Families teach invisible emotional rules: who can speak, when, and how. Those rules travel into adult intimacy.",
            counsel: "Your counsel: practice gentle honesty—one true sentence before you disappear."
          }
        ]
      },
      media: {
        label: "Media",
        bg: "#fce3e3",
        sub: "spark • drama • destiny",
        slips: [
          {
            pattern: "You read intensity as truth.",
            articulation: "People who learned love through media often mistake adrenaline for meaning—fast feelings look like fate.",
            context: "Stories compress time and reward high emotion. Real intimacy grows through repetition, reliability, and ordinary days.",
            counsel: "Your counsel: slow is not a lack of love. Let consistency be attractive."
          },
          {
            pattern: "Calm feels suspicious.",
            articulation: "When love is taught as a storyline, boredom feels like failure—so peace can look like ‘nothing is happening.’",
            context: "Modern romance content frames conflict as passion. But stable attachment often feels quiet: support, routines, repair.",
            counsel: "Your counsel: don’t chase adrenaline to prove love. Ask: do I feel safe here?"
          },
          {
            pattern: "You confuse chemistry with compatibility.",
            articulation: "Media often romanticizes turbulence. But intensity can be chemistry without kindness, devotion, or alignment.",
            context: "Some cultures also romanticize suffering as proof. In practice, peace is a love language too.",
            counsel: "Your counsel: choose peace on purpose. Love should not require constant crisis to feel real."
          }
        ]
      },
      religion: {
        label: "Religion",
        bg: "#fcfaf7",
        sub: "meaning • commitment • moral care",
        slips: [
          {
            pattern: "You take love seriously—beautifully.",
            articulation: "People who learned love through faith communities often treat love as practice and responsibility, not just a feeling.",
            context: "Community ethics can strengthen loyalty and care. Sometimes, the pressure to be ‘good’ can make normal conflict feel like failure.",
            counsel: "Your counsel: devotion should include tenderness toward yourself. Imperfection doesn’t cancel worth."
          },
          {
            pattern: "You fear disappointing others.",
            articulation: "When love is linked to goodness, people can confuse boundaries with selfishness—so they over-carry others’ expectations.",
            context: "Belonging is powerful. But shame-based belonging can silently shape how you ask for care.",
            counsel: "Your counsel: let values guide you—not shame. You can be kind and still be clear."
          },
          {
            pattern: "You hold desire and duty at once.",
            articulation: "When love is shaped by communal meaning, you may feel torn between personal longing and collective responsibility.",
            context: "Navigating love across expectations is a real cultural task, not personal weakness.",
            counsel: "Your counsel: choose in alignment with your values—without using fear as your compass."
          }
        ]
      },
      school: {
        label: "School",
        bg: "#e0f0f5",
        sub: "comparison • performance • belonging",
        slips: [
          {
            pattern: "You grade love like an exam.",
            articulation: "People who learned love through performance cultures often analyze signals constantly—certainty feels like safety.",
            context: "High-pressure environments train comparison and optimization. Uncertainty becomes emotionally expensive.",
            counsel: "Your counsel: ask directly once. One honest question can save 100 spirals."
          },
          {
            pattern: "You feel behind.",
            articulation: "When life is measured in milestones, love becomes another timeline—labels and progress can overshadow connection.",
            context: "Peer environments shape self-worth. ‘Keeping up’ becomes a hidden rule even in intimacy.",
            counsel: "Your counsel: stop grading love. Focus on growth, not speed."
          },
          {
            pattern: "You perform to be chosen.",
            articulation: "If belonging was conditional, you may earn love through competence—being ‘easy’ or ‘impressive’ becomes protection.",
            context: "Social hierarchies teach people to trade authenticity for acceptance. That habit can follow you into relationships.",
            counsel: "Your counsel: practice receiving without proving. Let care land."
          }
        ]
      },
      internet: {
        label: "Internet",
        bg: "#e8e1f5",
        sub: "attention • trends • detachment",
        slips: [
          {
            pattern: "You leave first to stay safe.",
            articulation: "People who learned love online often treat distance as dignity—ghosting becomes a way to avoid vulnerability.",
            context: "Attention economies normalize quick exits, endless options, and fear of looking ‘too much.’",
            counsel: "Your counsel: leave loudly—one clear sentence is kinder than disappearing."
          },
          {
            pattern: "You speak in hints.",
            articulation: "When love is mediated by signals—likes, views, timing—people can expect minds to be read instead of needs being spoken.",
            context: "High-context signaling works online, but it easily misfires across cultures, personalities, and nervous systems.",
            counsel: "Your counsel: say one thing plainly. Directness is not desperation."
          },
          {
            pattern: "Your feelings feel ‘not enough.’",
            articulation: "When life is curated, normal emotion can feel small—so you doubt your quiet love.",
            context: "Online comparison rewards extremes. Real intimacy often looks ordinary, steady, and un-postable.",
            counsel: "Your counsel: trust your quiet feelings. You don’t need to be loud to be real."
          }
        ]
      }
    };

    // Recognition lines (rotate, but not divination — they’re just thresholds)
    const recognitionLines = [
      "“Love is learned before it is chosen.”",
      "“Most patterns began as protection.”",
      "“What kept you safe once still guides you.”",
      "“This is not fate. It is recognition.”",
      "“No one is bad at love. They are trained by it.”"
    ];

    /* =========================
       RITUAL STATE
       ========================= */
    const tokenScreen = document.getElementById("token-screen");
    const recognitionScreen = document.getElementById("recognition-screen");
    const teacherGrid = document.getElementById("teacherGrid");
    const tokenDots = document.getElementById("tokenDots");
    const tokenStatus = document.getElementById("tokenStatus");
    const tokenClearBtn = document.getElementById("tokenClear");
    const beginRecognitionBtn = document.getElementById("beginRecognition");
    const backToTokensBtn = document.getElementById("backToTokens");
    const continueToSlipBtn = document.getElementById("continueToSlip");
    const recognitionLineEl = document.getElementById("recognitionLine");
    const countdownTextEl = document.getElementById("countdownText");
    const countBarEl = document.getElementById("countBar");

    // Steps
    const stepToken = document.getElementById("stepToken");
    const stepRecognize = document.getElementById("stepRecognize");
    const stepArticulate = document.getElementById("stepArticulate");
    const stepCounsel = document.getElementById("stepCounsel");

    let tokensTotal = 3;
    let tokensLeft = 3;
    let allocations = { family:0, media:0, religion:0, school:0, internet:0 };

    let primaryKey = null;
    let secondaryKey = null;
    let chosenSlipIndex = 0;

    function setStep(active){
      [stepToken, stepRecognize, stepArticulate, stepCounsel].forEach(s => s.classList.remove("active"));
      if(active === "token"){ stepToken.classList.add("active"); }
      if(active === "recognition"){ stepRecognize.classList.add("active"); }
      if(active === "articulation"){ stepArticulate.classList.add("active"); }
      if(active === "counsel"){ stepCounsel.classList.add("active"); }
    }

    function teacherOrder(){ return ["family","media","religion","school","internet"]; }

    function renderTokenDots(){
      tokenDots.innerHTML = "";
      for(let i=0;i<tokensTotal;i++){
        const d = document.createElement("span");
        d.className = "dot" + (i < tokensLeft ? " filled" : "");
        tokenDots.appendChild(d);
      }
    }

    function computePrimarySecondary(){
      const arr = teacherOrder().map(k => ({k, n: allocations[k]}));
      arr.sort((a,b)=> b.n - a.n || teacherOrder().indexOf(a.k) - teacherOrder().indexOf(b.k));
      primaryKey = arr[0].n > 0 ? arr[0].k : null;
      secondaryKey = arr[1].n > 0 ? arr[1].k : null;
      return { primaryKey, secondaryKey };
    }

    // Deterministic slip index from allocations (no randomness):
    // Uses a weighted hash so the same allocation always yields the same slip.
    function deterministicSlipIndex(forTeacherKey){
      const weights = { family:3, media:5, religion:7, school:11, internet:13 };
      let h = 0;
      for(const k of teacherOrder()){
        h += allocations[k] * weights[k];
      }
      const count = teachers[forTeacherKey].slips.length;
      return h % count;
    }

    function renderTeachers(){
      teacherGrid.innerHTML = "";
      computePrimarySecondary();

      teacherOrder().forEach(key=>{
        const t = teachers[key];
        const count = allocations[key];

        const card = document.createElement("div");
        card.className = "teacher";
        card.setAttribute("role","button");
        card.tabIndex = 0;

        const pips = Array.from({length:3}).map((_,i)=> `<span class="pip ${i < count ? "on":""}"></span>`).join("");

        card.innerHTML = `
          <div class="t-tag">${(primaryKey === key && allocations[key] > 0) ? "LEADING" : ""}</div>
          <div class="t-title">
            <span>${t.label}</span>
            <span style="font-size:.55rem; letter-spacing:2px; text-transform:uppercase; opacity:.75;">${t.sub}</span>
          </div>
          <div class="t-sub">Allocate influence, not preference</div>
          <div class="t-meter">
            <div class="t-count">Tokens: ${count}</div>
            <div class="pips">${pips}</div>
          </div>
        `;

        const addToken = ()=>{
          if(tokensLeft <= 0){
            tokenStatus.textContent = "No tokens left. You may begin recognition.";
            return;
          }
          allocations[key] += 1;
          tokensLeft -= 1;
          tokenStatus.textContent = "Token placed.";
          renderTokenDots();
          renderTeachers();
          beginRecognitionBtn.disabled = (tokensLeft !== 0);
        };

        card.addEventListener("click", addToken);
        card.addEventListener("keydown", (e)=>{
          if(e.key === "Enter" || e.key === " "){ e.preventDefault(); addToken(); }
        });

        teacherGrid.appendChild(card);
      });

      if(tokensLeft > 0){
        tokenStatus.textContent = "Place all 3 tokens to continue.";
        beginRecognitionBtn.disabled = true;
      } else {
        tokenStatus.textContent = "Allocation complete. Begin recognition.";
        beginRecognitionBtn.disabled = false;
      }

      // background becomes the primary teacher palette once determined (subtle prestige)
      if(primaryKey){
        document.body.style.backgroundColor = teachers[primaryKey].bg;
      } else {
        document.body.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue("--cream").trim() || "#f8f5f0";
      }
    }

    function clearTokens(){
      allocations = { family:0, media:0, religion:0, school:0, internet:0 };
      tokensLeft = tokensTotal;
      primaryKey = null; secondaryKey = null;
      tokenStatus.textContent = "Cleared.";
      renderTokenDots();
      renderTeachers();
      beginRecognitionBtn.disabled = true;
      setStep("token");
    }

    tokenClearBtn.addEventListener("click", clearTokens);

    /* =========================
       RECOGNITION GATE (3 seconds)
       ========================= */
    let recognitionTimer = null;

    function startRecognition(){
      computePrimarySecondary();
      if(!primaryKey){
        tokenStatus.textContent = "Please allocate tokens first.";
        return;
      }

      setStep("recognition");

      tokenScreen.style.display = "none";
      recognitionScreen.style.display = "block";

      // rotate a recognition line (non-divinatory threshold sentence)
      const idx = deterministicSlipIndex(primaryKey) % recognitionLines.length;
      recognitionLineEl.textContent = recognitionLines[idx];

      // 3-second gate (feels premium)
      continueToSlipBtn.disabled = true;
      let t = 3.0;
      countdownTextEl.textContent = "Continue unlocks in 3s";
      countBarEl.style.width = "0%";

      const start = performance.now();
      const duration = 3000;

      if(recognitionTimer) cancelAnimationFrame(recognitionTimer);

      const tick = (now)=>{
        const elapsed = now - start;
        const p = Math.min(1, elapsed / duration);
        countBarEl.style.width = (p * 100).toFixed(0) + "%";

        const remaining = Math.max(0, (duration - elapsed) / 1000);
        if(remaining > 0.01){
          countdownTextEl.textContent = `Continue unlocks in ${Math.ceil(remaining)}s`;
          recognitionTimer = requestAnimationFrame(tick);
        } else {
          countdownTextEl.textContent = "Ready.";
          continueToSlipBtn.disabled = false;
          countBarEl.style.width = "100%";
        }
      };
      recognitionTimer = requestAnimationFrame(tick);
    }

    beginRecognitionBtn.addEventListener("click", startRecognition);

    backToTokensBtn.addEventListener("click", ()=>{
      if(recognitionTimer) cancelAnimationFrame(recognitionTimer);
      recognitionScreen.style.display = "none";
      tokenScreen.style.display = "block";
      setStep("token");
    });

    /* =========================
       SLIP REVEAL (Articulation -> Counsel)
       ========================= */
    function showSlip(){
      computePrimarySecondary();
      if(!primaryKey) return;

      // deterministic choice of slip index
      chosenSlipIndex = deterministicSlipIndex(primaryKey);

      const slip = teachers[primaryKey].slips[chosenSlipIndex];

      // Steps
      setStep("articulation");
      // Then we also highlight counsel after render (tiny timing)
      setTimeout(()=> setStep("counsel"), 250);

      // Render result
      document.getElementById("ritual-screen").style.display = "none";
      const result = document.getElementById("result-screen");
      result.style.display = "block";

      document.getElementById("pill-primary").textContent = `Primary: ${teachers[primaryKey].label}`;
      document.getElementById("pill-secondary").textContent = `Secondary: ${secondaryKey ? teachers[secondaryKey].label : "—"}`;

      // “Pattern” line (frontLine)
      document.getElementById("frontLine").textContent = slip.pattern;

      // Articulation / Context / Counsel
      document.getElementById("articulationText").textContent = slip.articulation;
      document.getElementById("contextText").textContent = (secondaryKey
        ? `${slip.context} Secondary influence: ${teachers[secondaryKey].label} often colors how this pattern shows up.`
        : slip.context
      );
      document.getElementById("counselText").textContent = slip.counsel;

      // background to primary palette
      document.body.style.backgroundColor = teachers[primaryKey].bg;

      // Fade-in
      requestAnimationFrame(()=> { result.style.opacity = "1"; });

      // bind sound button on result
      const b2 = document.getElementById("soundBtn2");
      if (b2 && !b2.dataset.bound) {
        b2.dataset.bound = "1";
        b2.addEventListener('click', (e) => { e.stopPropagation(); toggleSound(); });
        updateSoundButtons();
      }
    }

    continueToSlipBtn.addEventListener("click", showSlip);

    /* =========================
       SAVE IMAGE
       ========================= */
    function saveImage(){
      const captureArea = document.getElementById('capture-frame');
      html2canvas(captureArea, { backgroundColor: null, scale: 2 }).then(canvas => {
        const link = document.createElement('a');
        link.download = 'HeartToHeart_ISA_ReflectionSlip.png';
        link.href = canvas.toDataURL("image/png");
        link.click();
      });
    }
    window.saveImage = saveImage;

    /* =========================
       INIT
       ========================= */
    renderTokenDots();
    renderTeachers();
    setStep("token");
  </script>
</body>
</html>
